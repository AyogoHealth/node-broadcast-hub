(function(){var a,b,c,d=function(a,b){return function(){return a.apply(b,arguments)}},e=[].indexOf||function(a){for(var b=0,c=this.length;c>b;b++)if(b in this&&this[b]===a)return b;return-1},f=[].slice;if(c=this,b=c.SockJS,!b)throw Error("No SockJS found, be sure to include it!");a=function(){function a(a){this.options=null!=a?a:{},this._onDisconnected=d(this._onDisconnected,this),this._onConnected=d(this._onConnected,this),this._processMessage=d(this._processMessage,this),this._listeners={},this._channels=[],this._queue=[],this._connected=!1,this._shuttingDown=!1,this._seq=0,this.connect()}return a.prototype.connect=function(){if(this.client)throw new Error("Already have a client!");return this.client=new b(this.options.server||"/sockets"),this.client.onopen=this._onConnected,this.client.onclose=this._onDisconnected,this.client.onmessage=this._processMessage},a.prototype.on=function(a,b){return b?(this._listeners[a]||(this._listeners[a]=[]),this._listeners[a].push(b)):void 0},a.prototype.once=function(a,b){var c;if(b)return c=function(){return b.apply(this,arguments),this.off(a,c)},this.on(a,c)},a.prototype.off=function(a,b){return!this._listeners[a]||e.call(this._listeners[a],b)<0?void 0:this._listeners[a].splice(this._listeners[a].indexOf(b),1)},a.prototype.emit=function(){var a,b,c,d,e,g,h;if(b=arguments[0],a=2<=arguments.length?f.call(arguments,1):[],this._listeners[b]){for(g=this._listeners[b],h=[],d=0,e=g.length;e>d;d++)c=g[d],h.push(c.apply(this,a));return h}},a.prototype._processMessage=function(a){var b;return b=JSON.parse(a.data),"callback"===b.type?this.emit("_callback:"+b.seq,b.err,b.data):(this.emit("message:"+b.channel,b.message),this.emit("message",b.channel,b.message))},a.prototype._onConnected=function(){var a,b,c,d,e,f,g,h,i;for(this._shuttingDown=!1,this._connected=!0,g=this._queue,c=0,e=g.length;e>c;c++)b=g[c],this.client.send(JSON.stringify(b));for(this._queue=[],h=this._channels,i=[],d=0,f=h.length;f>d;d++)a=h[d],i.push(this.subscribe(a));return i},a.prototype._onDisconnected=function(){return this.client.onopen=null,this.client.onclose=null,this.client.onmessage=null,this.client=null,this._connected=!1,this.emit("disconnected"),this._shuttingDown?void 0:this.connect()},a.prototype.disconnect=function(a){var b=this;return this._shuttingDown=!0,this._connected?(this.once("disconnected",a),this.send({message:"disconnect"},function(){return b.client.close()})):(a&&a(),void 0)},a.prototype.send=function(a,b){return null==a&&(a={}),b&&(a._seq=this._seq++,this.once("_callback:"+a._seq,b)),this._connected?this.client.send(JSON.stringify(a)):this._queue.push(a),a._seq},a.prototype.subscribe=function(a,b){var c=this;return this.send({message:"hubSubscribe",channel:a},function(d){return d?(b&&b(d),void 0):(e.call(c._channels,a)<0&&c._channels.push(a),b?b():void 0)})},a}(),"undefined"!=typeof module?module.exports=a:c.BroadcastHubClient=a}).call(this);